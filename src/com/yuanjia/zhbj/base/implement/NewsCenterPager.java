package com.yuanjia.zhbj.base.implement;

import java.util.ArrayList;

import android.app.Activity;
import android.graphics.Color;
import android.os.IBinder;
import android.text.TextUtils;
import android.view.Gravity;
import android.view.View;
import android.widget.ImageButton;
import android.widget.TextView;
import android.widget.Toast;




import com.google.gson.Gson;
import com.lidroid.xutils.HttpUtils;
import com.lidroid.xutils.exception.HttpException;
import com.lidroid.xutils.http.ResponseInfo;
import com.lidroid.xutils.http.callback.RequestCallBack;
import com.lidroid.xutils.http.client.HttpRequest.HttpMethod;
import com.yuanjia.zhbj.HomeActivity;
import com.yuanjia.zhbj.base.BaseMenuDetailPager;
import com.yuanjia.zhbj.base.BasePager;
import com.yuanjia.zhbj.base.menudetail.InteractMenuDetailPager;
import com.yuanjia.zhbj.base.menudetail.NewsMenuDetailPager;
import com.yuanjia.zhbj.base.menudetail.PhotoMenuDetailPager;
import com.yuanjia.zhbj.base.menudetail.TopicMenuDetailPager;
import com.yuanjia.zhbj.domain.NewsData;
import com.yuanjia.zhbj.domain.NewsData.NewsMenuData;
import com.yuanjia.zhbj.fragment.LeftMenuFragment;
import com.yuanjia.zhbj.global.GlobalContants;
import com.yuanjia.zhbj.utils.CacheUtils;

public class NewsCenterPager extends BasePager {

	private NewsData mNewsData;
	private ArrayList<BaseMenuDetailPager> mPagers;
	private NewsMenuData menuData;
	
	public NewsCenterPager(Activity activity) {
		super(activity);
	}

	@Override
	public void initData() {

		System.out.println("初始化。。。。");
		
//		tv_title.setText("智慧北京"); //修改标题
//		btn_menu.setVisibility(View.GONE);//隐藏菜单按钮
		setSlidingMenuEnable(true); //隐藏侧边栏
		
//		TextView text = new TextView(mActivity);
//		text.setText("新闻中心");
//		text.setTextColor(Color.RED);
//        text.setTextSize(25);
//        text.setGravity(Gravity.CENTER);
//        
//        fl_content.addView(text);//向FragmentLayout中动态添加布局
      
		
		String cacheSliding = CacheUtils.getCache(mActivity, GlobalContants.CATEGORIES_URL);
		if(!TextUtils.isEmpty(cacheSliding)){
			parseData(cacheSliding);//如果缓存存在，直接读取缓存，无需访问网络
			
		}
		getDataFromServer();//不管有没有缓存，都获取最新的数据，保证数据最新
	}

	/**
	 * 从服务器获取数据
	 */
	private void getDataFromServer() {
		HttpUtils utils = new HttpUtils();
		utils.send(HttpMethod.GET, GlobalContants.CATEGORIES_URL, new RequestCallBack<String>() {

			private String result;

			//访问成功
			@Override
			public void onSuccess(ResponseInfo responseInfo) {
				result = (String) responseInfo.result;
				System.out.println("返回结果："+result);
				if(result != null){
					
					parseData(result);
					
					//设置缓存
					CacheUtils.setCache(mActivity, GlobalContants.CATEGORIES_URL, result);
				}
			}

			//访问失败
			@Override
			public void onFailure(HttpException error, String msg) {
				Toast.makeText(mActivity, msg, 0).show();
				error.printStackTrace();
			}
		});
	}
	
    /**
     * 解析网络数据
     * @param result
     */
	protected void parseData(String result) {
		Gson gson = new Gson();
		mNewsData = gson.fromJson(result, NewsData.class);
		System.out.println("解析结果："+mNewsData);
		
		//刷新侧边栏的数据
		HomeActivity mainUi = (HomeActivity)mActivity;
		LeftMenuFragment leftMenuFragment = mainUi.getLeftMenuFragment();
		leftMenuFragment.setMenuData(mNewsData);
		
		//准备四个菜单详情页
		mPagers = new ArrayList<BaseMenuDetailPager>();
		mPagers.add(new NewsMenuDetailPager(mActivity,mNewsData.data.get(0).children));
		mPagers.add(new TopicMenuDetailPager(mActivity));
		mPagers.add(new PhotoMenuDetailPager(mActivity,btn_photo));
		mPagers.add(new InteractMenuDetailPager(mActivity));
		
		setCurrentMenuDetailPager(0);  //当点击新闻中心页，设置菜单详情页为第一个
	}

	//设置当前菜单详情页
	public void setCurrentMenuDetailPager(int position) {
		BaseMenuDetailPager paper = mPagers.get(position);//获取当前要显示的菜单详情页
		fl_content.removeAllViews();//清理之前的布局
		fl_content.addView(paper.mRootView);//将菜单详情页的布局设置给帧布局
			
		//设置当前页的标题
		menuData = mNewsData.data.get(position);
		tv_title.setText(menuData.title);
		
		//初始化当前页面的数据
		paper.initData();
	}

	

	
	
}
